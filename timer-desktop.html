<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#282c34">
  <title>타이머 앱</title>
  <style>
    /* ========== 기본 스타일 초기화 ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
    }

    /* ========== 메인 화면 ========== */
    #mainScreen {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s;
      position: relative;
    }

    #settingsBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      font-size: 28px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
      transition: transform 0.2s;
    }

    #settingsBtn:active {
      transform: scale(0.9);
    }

    .clock-container {
      text-align: center;
    }

    #dateDisplay {
      font-size: 100px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    #timeDisplay {
      font-size: 200px;
      font-weight: bold;
      line-height: 1;
    }

    .time-ampm, .time-seconds {
      font-size: 50%;
      opacity: 0.8;
    }

    /* ========== 타이머 카드 오버레이 ========== */
    #timerCardsOverlay {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      z-index: 100;
      pointer-events: none;
    }

    #timerCardsOverlay.show {
      display: block;
    }

    .cards-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 70%;
      background: white;
      border-radius: 20px 20px 0 0;
      padding: 20px;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      pointer-events: auto;
    }

    #timerCardsOverlay.show .cards-container {
      transform: translateY(0);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    @media (orientation: landscape) {
      .cards-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    .timer-card {
      aspect-ratio: 1;
      border: 2px solid #ddd;
      border-radius: 15px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      transition: transform 0.2s;
      background: white;
    }

    .timer-card:active {
      transform: scale(0.95);
    }

    .timer-card.add-card {
      border-style: dashed;
      justify-content: center;
      align-items: center;
      font-size: 40px;
      color: #999;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .card-name {
      font-weight: bold;
      font-size: 14px;
      flex: 1;
    }

    .card-menu-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .card-info {
      font-size: 11px;
      color: #666;
      line-height: 1.5;
    }

    /* ========== 모달 ========== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 30px;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
    }

    .setting-section {
      margin-bottom: 20px;
    }

    .setting-label {
      font-weight: bold;
      margin-bottom: 10px;
      display: block;
    }

    /* ========== 시간 선택기 ========== */
    .time-picker {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      justify-content: center;
    }

    .time-input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .time-control-btn {
      width: 60px;
      height: 40px;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #007AFF;
      border-radius: 8px;
      background: white;
      color: #007AFF;
      cursor: pointer;
      transition: all 0.2s;
    }

    .time-control-btn:active {
      background: #007AFF;
      color: white;
    }

    .time-input {
      width: 60px;
      height: 50px;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      border: 2px solid #007AFF;
      border-radius: 8px;
    }

    .time-separator {
      font-size: 32px;
      font-weight: bold;
      margin: 0 5px;
    }

    /* ========== 소리 선택 ========== */
    .sound-select-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .sound-select-item {
      flex: 1;
    }

    .sound-select-item label {
      font-size: 12px;
      display: block;
      margin-bottom: 5px;
    }

    .sound-select-item select {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border: 2px solid #007AFF;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }

    .color-picker-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .color-picker-item {
      flex: 1;
    }

    .color-picker-item label {
      font-size: 12px;
      display: block;
      margin-bottom: 5px;
    }

    .color-picker-item input[type="color"] {
      width: 100%;
      height: 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
    }

    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .slider-container {
      margin: 10px 0;
    }

    input[type="range"] {
      width: 100%;
      height: 40px;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .checkbox-container input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .file-upload-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }

    .file-upload-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px dashed #007AFF;
      border-radius: 10px;
      background: #f0f8ff;
      color: #007AFF;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
      display: block;
      text-align: center;
    }

    input[type="file"] {
      display: none;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:active {
      opacity: 0.7;
    }

    .btn-primary {
      background: #007AFF;
      color: white;
    }

    .btn-danger {
      background: #FF3B30;
      color: white;
    }

    .btn-secondary {
      background: #8E8E93;
      color: white;
    }

    /* ========== 타이머 실행 화면 ========== */
    #timerScreen {
      display: none;
      width: 100vw;
      height: 100vh;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      transition: filter 0.3s;
    }

    #timerScreen.show {
      display: flex;
    }

    #timerScreen.paused {
      filter: blur(5px) brightness(0.5);
    }

    #timerSettingsBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      font-size: 28px;
      background: rgba(255,255,255,0.3);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
    }

    .pause-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 250;
      pointer-events: none;
    }

    .pause-overlay.show {
      display: flex;
    }

    .pause-text {
      font-size: 80px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 20px rgba(0,0,0,0.8);
    }

    .current-time-small {
      position: absolute;
      top: 20px;
      text-align: center;
      font-size: 50px;
      padding: 10px 20px;
      border-radius: 10px;
    }

    .timer-display {
      text-align: center;
    }

    .timer-info-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #timerTime {
      font-size: 200px;
      font-weight: bold;
      line-height: 1;
    }

    .timer-name {
      margin-top: 10px;
      opacity: 0.8;
    }

    .stop-guide {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 16px;
      display: none;
      z-index: 300;
    }

    .stop-guide.show {
      display: block;
    }

    .progress-circle {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120px;
      height: 120px;
      display: none;
      z-index: 300;
    }

    .progress-circle.show {
      display: block;
      animation: rotate 2s linear;
    }

    .progress-circle circle {
      fill: none;
      stroke: #ffffff;
      stroke-width: 10;
      stroke-dasharray: 339;
      stroke-dashoffset: 339;
      transform-origin: center;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
    }

    .progress-circle.filling circle {
      animation: fillProgress 2s linear forwards;
    }

    @keyframes fillProgress {
      to {
        stroke-dashoffset: 0;
      }
    }

    @keyframes rotate {
      from {
        transform: translate(-50%, -50%) rotate(0deg);
      }
      to {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 14px;
      display: none;
      z-index: 400;
      animation: fadeInOut 3s;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      10%, 90% { opacity: 1; }
    }

    .toast.show {
      display: block;
    }
  </style>
</head>
<body>
  <div id="mainScreen">
    <button id="settingsBtn">⚙️</button>
    <div class="clock-container">
      <div id="dateDisplay"></div>
      <div id="timeDisplay">
        <span class="time-ampm" id="ampm"></span>
        <span id="hours"></span>:<span id="minutes"></span>
        <span class="time-seconds" id="seconds"></span>
      </div>
    </div>
  </div>

  <div id="timerCardsOverlay">
    <div class="cards-container">
      <div class="cards-grid" id="cardsGrid"></div>
    </div>
  </div>

  <div id="timerScreen">
    <button id="timerSettingsBtn">⚙️</button>
    <div class="current-time-small" id="currentTimeSmall"></div>
    <div class="timer-display">
      <div class="timer-info-top">
        <span class="timer-phase" id="timerPhase">준비</span>
        <span class="timer-round" id="timerRound">1/3</span>
      </div>
      <div id="timerTime">
        <span id="timerMinutes">00</span>:<span id="timerSeconds">00</span>
      </div>
      <div class="timer-name" id="timerName">타이머 1</div>
    </div>
  </div>

  <div class="pause-overlay" id="pauseOverlay">
    <div class="pause-text">일시정지</div>
  </div>

  <div class="stop-guide" id="stopGuide">길게 누르면 종료</div>

  <svg class="progress-circle" id="progressCircle" viewBox="0 0 120 120">
    <circle cx="60" cy="60" r="54"></circle>
  </svg>

  <div class="toast" id="toast"></div>

  <div class="modal" id="timerSettingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">타이머 설정</div>
        <button class="close-btn" onclick="closeTimerSettings()">×</button>
      </div>
      
      <div class="setting-section">
        <label class="setting-label">타이머 이름</label>
        <input type="text" id="timerNameInput" placeholder="타이머 이름">
      </div>

      <div class="setting-section">
        <label class="setting-label">준비 시간</label>
        <div class="time-picker">
          <div class="time-input-group">
            <button type="button" class="time-control-btn" onclick="changeTime('prepareMin', 1)">▲</button>
            <input type="number" id="prepareMin" class="time-input" min="0" max="99" value="0">
            <button type="button" class="time-control-btn" onclick="changeTime('prepareMin', -1)">▼</button>
          </div>
          <span class="time-separator">:</span>
          <div class="time-input-group">
            <button type="button" class="time-control-btn" onclick="changeTime('prepareSec', 1)">▲</button>
            <input type="number" id="prepareSec" class="time-input" min="0" max="59" value="10">
            <button type="button" class="time-control-btn" onclick="changeTime('prepareSec', -1)">▼</button>
          </div>
        </div>
        <div class="color-picker-group">
          <div class="color-picker-item">
            <label>배경색</label>
            <input type="color" id="prepareBg" value="#FFA500">
          </div>
          <div class="color-picker-item">
            <label>글자색</label>
            <input type="color" id="prepareColor" value="#FFFFFF">
          </div>
        </div>
        <div class="sound-select-group">
          <div class="sound-select-item">
            <label>시작음</label>
            <select id="prepareStartSound">
              <option value="none">무음</option>
              <option value="default" selected>기본음</option>
              <option value="beep">삐</option>
              <option value="bell">딩동</option>
            </select>
          </div>
          <div class="sound-select-item">
            <label>종료음</label>
            <select id="prepareEndSound">
              <option value="none">무음</option>
              <option value="default">기본음</option>
              <option value="beep" selected>삐</option>
              <option value="bell">딩동</option>
            </select>
          </div>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">운동 시간</label>
        <div class="time-picker">
          <div class="time-input-group">
            <button type="button" class="time-control-btn" onclick="changeTime('workMin', 1)">▲</button>
            <input type="number" id="workMin" class="time-input" min="0" max="99" value="0">
            <button type="button" class="time-control-btn" onclick="changeTime('workMin', -1)">▼</button>
          </div>
          <span class="time-separator">:</span>
          <div class="time-input-group">
            <button type="button" class="time-control-btn" onclick="changeTime('workSec', 1)">▲</button>
            <input type="number" id="workSec" class="time-input" min="0" max="59" value="30">
            <button type="button" class="time-control-btn" onclick="changeTime('workSec', -1)">▼</button>
          </div>
        </div>
        <div class="color-picker-group">
          <div class="color-picker-item">
            <label>배경색</label>
            <input type="color" id="workBg" value="#FF0000">
          </div>
          <div class="color-picker-item">
            <label>글자색</label>
            <input type="color" id="workColor" value="#FFFFFF">
          </div>
        </div>
        <div class="sound-select-group">
          <div class="sound-select-item">
            <label>시작음</label>
            <select id="workStartSound">
              <option value="none">무음</option>
              <option value="default" selected>기본음</option>
              <option value="beep">삐</option>
              <option value="bell">딩동</option>
            </select>
          </div>
          <div class="sound-select-item">
            <label>종료음</label>
            <select id="workEndSound">
              <option value="none">무음</option>
              <option value="default">기본음</option>
              <option value="beep" selected>삐</option>
              <option value="bell">딩동</option>
            </select>
          </div>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">휴식 시간</label>
        <div class="time-picker">
          <div class="time-input-group">
            <button type="button" class="time-control-btn" onclick="changeTime('restMin', 1)">▲</button>
            <input type="number" id="restMin" class="time-input" min="0" max="99" value="0">
            <button type="button" class="time-control-btn" onclick="changeTime('restMin', -1)">▼</button>
          </div>
          <span class="time-separator">:</span>
          <div class="time-input-group">
            <button type="button" class="time-control-btn" onclick="changeTime('restSec', 1)">▲</button>
            <input type="number" id="restSec" class="time-input" min="0" max="59" value="10">
            <button type="button" class="time-control-btn" onclick="changeTime('restSec', -1)">▼</button>
          </div>
        </div>
        <div class="color-picker-group">
          <div class="color-picker-item">
            <label>배경색</label>
            <input type="color" id="restBg" value="#00FF00">
          </div>
          <div class="color-picker-item">
            <label>글자색</label>
            <input type="color" id="restColor" value="#000000">
          </div>
        </div>
        <div class="sound-select-group">
          <div class="sound-select-item">
            <label>시작음</label>
            <select id="restStartSound">
              <option value="none">무음</option>
              <option value="default" selected>기본음</option>
              <option value="beep">삐</option>
              <option value="bell">딩동</option>
            </select>
          </div>
          <div class="sound-select-item">
            <label>종료음</label>
            <select id="restEndSound">
              <option value="none">무음</option>
              <option value="default">기본음</option>
              <option value="beep" selected>삐</option>
              <option value="bell">딩동</option>
            </select>
          </div>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">라운드</label>
        <input type="number" id="rounds" min="1" max="99" value="3">
      </div>

      <div class="setting-section">
        <label class="setting-label">볼륨</label>
        <div class="slider-container">
          <input type="range" id="volume" min="0" max="100" value="50">
        </div>
      </div>

      <div class="file-upload-section">
        <label class="setting-label">커스텀 음원 추가</label>
        <input type="file" id="customSoundFile" accept="audio/*" multiple>
        <label for="customSoundFile" class="file-upload-btn">📁 음원 파일 업로드</label>
      </div>

      <div class="btn-group">
        <button class="btn btn-danger" onclick="deleteTimer()">삭제</button>
        <button class="btn btn-secondary" onclick="copyTimer()">복사</button>
        <button class="btn btn-primary" onclick="saveTimer()">확인</button>
      </div>
    </div>
  </div>

  <div class="modal" id="globalSettingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">현재시간 설정</div>
        <button class="close-btn" onclick="closeGlobalSettings()">×</button>
      </div>
      
      <div class="setting-section">
        <label class="setting-label">날짜 크기 (%)</label>
        <div class="slider-container">
          <input type="range" id="dateSize" min="50" max="200" value="100">
          <div id="dateSizeValue">100%</div>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">시계 크기 (%)</label>
        <div class="slider-container">
          <input type="range" id="clockSize" min="50" max="200" value="100">
          <div id="clockSizeValue">100%</div>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">배경색</label>
        <input type="color" id="bgColor" value="#282c34">
      </div>

      <div class="setting-section">
        <label class="setting-label">글자색</label>
        <input type="color" id="fontColor" value="#ffffff">
      </div>

      <div class="setting-section">
        <label class="setting-label">화면 꺼짐 방지</label>
        <div class="checkbox-container">
          <input type="checkbox" id="keepScreenOn" checked>
          <label for="keepScreenOn">타이머 실행 중 화면 유지</label>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">소리</label>
        <div class="checkbox-container">
          <input type="checkbox" id="soundEnabled" checked>
          <label for="soundEnabled">소리 재생</label>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">진동</label>
        <div class="checkbox-container">
          <input type="checkbox" id="vibrationEnabled" checked>
          <label for="vibrationEnabled">진동 피드백</label>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveGlobalSettings()">확인</button>
      </div>
    </div>
  </div>

  <div class="modal" id="timerScreenSettingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">타이머 화면 설정</div>
        <button class="close-btn" onclick="closeTimerScreenSettings()">×</button>
      </div>
      
      <div class="setting-section">
        <label class="setting-label">숫자 크기 (%)</label>
        <div class="slider-container">
          <input type="range" id="timerNumberSize" min="50" max="200" value="100">
          <div id="timerNumberSizeValue">100%</div>
        </div>
      </div>

      <div class="setting-section">
        <label class="setting-label">글자 크기 (%)</label>
        <div class="slider-container">
          <input type="range" id="timerTextSize" min="50" max="200" value="100">
          <div id="timerTextSizeValue">100%</div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveTimerScreenSettings()">확인</button>
      </div>
    </div>
  </div>

  <script>
    let timers = [];
    let currentTimerId = null;
    let runningTimer = null;
    let timerInterval = null;
    let isPaused = false;
    let longPressTimer = null;
    let audioContext = null;
    let wakeLock = null;
    let customSounds = {};

    let globalSettings = {
      dateSize: 100,
      clockSize: 100,
      bgColor: '#282c34',
      fontColor: '#ffffff',
      keepScreenOn: true,
      soundEnabled: true,
      vibrationEnabled: true
    };

    let timerScreenSettings = {
      numberSize: 100,
      textSize: 100
    };

    window.addEventListener('load', () => {
      loadSettings();
      loadTimerScreenSettings();
      loadTimers();
      renderCards();
      updateClock();
      setInterval(updateClock, 1000);
      setupEventListeners();
      setTimeout(() => applyGlobalSettings(), 100);
      // AudioContext는 사용자 인터랙션 후에 초기화
    });

    function setupEventListeners() {
      document.getElementById('mainScreen').addEventListener('click', showTimerCards);
      document.getElementById('timerCardsOverlay').addEventListener('click', function(e) {
        if (e.target === this) hideTimerCards();
      });
      document.getElementById('timerScreen').addEventListener('click', handleTimerScreenClick);
      document.getElementById('settingsBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        showGlobalSettings();
      });
      document.getElementById('timerSettingsBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        showTimerScreenSettings();
      });
      document.getElementById('timerScreen').addEventListener('touchstart', handleLongPressStart);
      document.getElementById('timerScreen').addEventListener('touchend', handleLongPressEnd);
      document.getElementById('timerScreen').addEventListener('mousedown', handleLongPressStart);
      document.getElementById('timerScreen').addEventListener('mouseup', handleLongPressEnd);
      document.getElementById('customSoundFile').addEventListener('change', handleCustomSoundUpload);
    }

    function changeTime(inputId, delta) {
      const input = document.getElementById(inputId);
      let value = parseInt(input.value) || 0;
      value += delta;
      if (inputId.includes('Sec')) {
        if (value > 59) value = 0;
        if (value < 0) value = 59;
      } else {
        if (value > 99) value = 99;
        if (value < 0) value = 0;
      }
      input.value = value;
    }

    function updateClock() {
      const now = new Date();
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const date = String(now.getDate()).padStart(2, '0');
      const day = days[now.getDay()];
      document.getElementById('dateDisplay').textContent = year + '.' + month + '.' + date + ' ' + day + '요일';
      let hours = now.getHours();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('ampm').textContent = ampm + ' ';
      document.getElementById('hours').textContent = String(hours).padStart(2, '0');
      document.getElementById('minutes').textContent = minutes;
      document.getElementById('seconds').textContent = ' ' + seconds;
      if (document.getElementById('timerScreen').classList.contains('show')) {
        document.getElementById('currentTimeSmall').textContent = ampm + ' ' + String(hours).padStart(2, '0') + ':' + minutes;
      }
    }

    function applyGlobalSettings() {
      const dateEl = document.getElementById('dateDisplay');
      if (dateEl) dateEl.style.fontSize = globalSettings.dateSize + 'px';
      const timeEl = document.getElementById('timeDisplay');
      if (timeEl) timeEl.style.fontSize = (globalSettings.clockSize * 2) + 'px';
      // timerTime은 여기서 설정하지 않음 (타이머 화면 설정과 독립)
      document.getElementById('mainScreen').style.backgroundColor = globalSettings.bgColor;
      document.getElementById('mainScreen').style.color = globalSettings.fontColor;
    }

    function showGlobalSettings() {
      document.getElementById('dateSize').value = globalSettings.dateSize;
      document.getElementById('dateSizeValue').textContent = globalSettings.dateSize + '%';
      document.getElementById('clockSize').value = globalSettings.clockSize;
      document.getElementById('clockSizeValue').textContent = globalSettings.clockSize + '%';
      document.getElementById('bgColor').value = globalSettings.bgColor;
      document.getElementById('fontColor').value = globalSettings.fontColor;
      document.getElementById('keepScreenOn').checked = globalSettings.keepScreenOn;
      document.getElementById('soundEnabled').checked = globalSettings.soundEnabled;
      document.getElementById('vibrationEnabled').checked = globalSettings.vibrationEnabled;
      document.getElementById('globalSettingsModal').classList.add('show');
      document.getElementById('dateSize').oninput = function() {
        document.getElementById('dateSizeValue').textContent = this.value + '%';
        document.getElementById('dateDisplay').style.fontSize = this.value + 'px';
      };
      document.getElementById('clockSize').oninput = function() {
        document.getElementById('clockSizeValue').textContent = this.value + '%';
        document.getElementById('timeDisplay').style.fontSize = (this.value * 2) + 'px';
      };
      document.getElementById('bgColor').oninput = function() {
        document.getElementById('mainScreen').style.backgroundColor = this.value;
      };
      document.getElementById('fontColor').oninput = function() {
        document.getElementById('mainScreen').style.color = this.value;
      };
    }

    function closeGlobalSettings() {
      document.getElementById('globalSettingsModal').classList.remove('show');
    }

    function saveGlobalSettings() {
      globalSettings.dateSize = parseInt(document.getElementById('dateSize').value);
      globalSettings.clockSize = parseInt(document.getElementById('clockSize').value);
      globalSettings.bgColor = document.getElementById('bgColor').value;
      globalSettings.fontColor = document.getElementById('fontColor').value;
      globalSettings.keepScreenOn = document.getElementById('keepScreenOn').checked;
      globalSettings.soundEnabled = document.getElementById('soundEnabled').checked;
      globalSettings.vibrationEnabled = document.getElementById('vibrationEnabled').checked;
      localStorage.setItem('globalSettings', JSON.stringify(globalSettings));
      applyGlobalSettings();
      closeGlobalSettings();
      showToast('설정이 저장되었습니다');
    }

    function showTimerCards() {
      document.getElementById('timerCardsOverlay').classList.add('show');
    }

    function hideTimerCards() {
      document.getElementById('timerCardsOverlay').classList.remove('show');
    }

    function renderCards() {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = '';
      timers.forEach(timer => {
        const card = createTimerCard(timer);
        grid.appendChild(card);
      });
      const addCard = document.createElement('div');
      addCard.className = 'timer-card add-card';
      addCard.innerHTML = '+';
      addCard.onclick = () => addNewTimer();
      grid.appendChild(addCard);
    }

    function createTimerCard(timer) {
      const card = document.createElement('div');
      card.className = 'timer-card';
      card.onclick = (e) => {
        if (!e.target.classList.contains('card-menu-btn')) {
          startTimer(timer.id);
        }
      };
      card.innerHTML = '<div class="card-header"><div class="card-name">' + timer.name + '</div><button class="card-menu-btn" onclick="event.stopPropagation(); editTimer(\'' + timer.id + '\')">⋮</button></div><div class="card-info">준비: ' + timer.prepare.min + '분 ' + timer.prepare.sec + '초<br>운동: ' + timer.work.min + '분 ' + timer.work.sec + '초<br>휴식: ' + timer.rest.min + '분 ' + timer.rest.sec + '초<br>라운드: ' + timer.rounds + '</div>';
      return card;
    }

    function addNewTimer() {
      currentTimerId = 'timer_' + Date.now();
      const newTimer = {
        id: currentTimerId,
        name: '타이머 ' + (timers.length + 1),
        prepare: { min: 0, sec: 10, bg: '#FFA500', color: '#FFFFFF', startSound: 'default', endSound: 'beep' },
        work: { min: 0, sec: 30, bg: '#FF0000', color: '#FFFFFF', startSound: 'default', endSound: 'beep' },
        rest: { min: 0, sec: 10, bg: '#00FF00', color: '#000000', startSound: 'default', endSound: 'beep' },
        rounds: 3,
        volume: 50
      };
      timers.push(newTimer);
      editTimer(currentTimerId);
    }

    function editTimer(id) {
      currentTimerId = id;
      const timer = timers.find(t => t.id === id);
      if (!timer) return;
      document.getElementById('timerNameInput').value = timer.name;
      document.getElementById('prepareMin').value = timer.prepare.min;
      document.getElementById('prepareSec').value = timer.prepare.sec;
      document.getElementById('prepareBg').value = timer.prepare.bg;
      document.getElementById('prepareColor').value = timer.prepare.color;
      document.getElementById('prepareStartSound').value = timer.prepare.startSound || 'default';
      document.getElementById('prepareEndSound').value = timer.prepare.endSound || 'beep';
      document.getElementById('workMin').value = timer.work.min;
      document.getElementById('workSec').value = timer.work.sec;
      document.getElementById('workBg').value = timer.work.bg;
      document.getElementById('workColor').value = timer.work.color;
      document.getElementById('workStartSound').value = timer.work.startSound || 'default';
      document.getElementById('workEndSound').value = timer.work.endSound || 'beep';
      document.getElementById('restMin').value = timer.rest.min;
      document.getElementById('restSec').value = timer.rest.sec;
      document.getElementById('restBg').value = timer.rest.bg;
      document.getElementById('restColor').value = timer.rest.color;
      document.getElementById('restStartSound').value = timer.rest.startSound || 'default';
      document.getElementById('restEndSound').value = timer.rest.endSound || 'beep';
      document.getElementById('rounds').value = timer.rounds;
      document.getElementById('volume').value = timer.volume;
      document.getElementById('timerSettingsModal').classList.add('show');
    }

    function closeTimerSettings() {
      document.getElementById('timerSettingsModal').classList.remove('show');
    }

    function saveTimer() {
      const timer = timers.find(t => t.id === currentTimerId);
      if (!timer) return;
      timer.name = document.getElementById('timerNameInput').value;
      timer.prepare.min = parseInt(document.getElementById('prepareMin').value) || 0;
      timer.prepare.sec = parseInt(document.getElementById('prepareSec').value) || 0;
      timer.prepare.bg = document.getElementById('prepareBg').value;
      timer.prepare.color = document.getElementById('prepareColor').value;
      timer.prepare.startSound = document.getElementById('prepareStartSound').value;
      timer.prepare.endSound = document.getElementById('prepareEndSound').value;
      timer.work.min = parseInt(document.getElementById('workMin').value) || 0;
      timer.work.sec = parseInt(document.getElementById('workSec').value) || 0;
      timer.work.bg = document.getElementById('workBg').value;
      timer.work.color = document.getElementById('workColor').value;
      timer.work.startSound = document.getElementById('workStartSound').value;
      timer.work.endSound = document.getElementById('workEndSound').value;
      timer.rest.min = parseInt(document.getElementById('restMin').value) || 0;
      timer.rest.sec = parseInt(document.getElementById('restSec').value) || 0;
      timer.rest.bg = document.getElementById('restBg').value;
      timer.rest.color = document.getElementById('restColor').value;
      timer.rest.startSound = document.getElementById('restStartSound').value;
      timer.rest.endSound = document.getElementById('restEndSound').value;
      timer.rounds = parseInt(document.getElementById('rounds').value);
      timer.volume = parseInt(document.getElementById('volume').value);
      saveTimers();
      renderCards();
      closeTimerSettings();
      showToast('타이머가 저장되었습니다');
    }

    function deleteTimer() {
      if (confirm('이 타이머를 삭제하시겠습니까?')) {
        timers = timers.filter(t => t.id !== currentTimerId);
        saveTimers();
        renderCards();
        closeTimerSettings();
        showToast('타이머가 삭제되었습니다');
      }
    }

    function copyTimer() {
      const timer = timers.find(t => t.id === currentTimerId);
      if (!timer) return;
      const newTimer = JSON.parse(JSON.stringify(timer));
      newTimer.id = 'timer_' + Date.now();
      newTimer.name = timer.name + ' 복사';
      timers.push(newTimer);
      saveTimers();
      renderCards();
      closeTimerSettings();
      showToast('타이머가 복사되었습니다');
    }

    function startTimer(id) {
      const timer = timers.find(t => t.id === id);
      if (!timer) return;
      hideTimerCards();
      runningTimer = {
        config: timer,
        phase: 'prepare',
        currentRound: 1,
        remainingTime: timer.prepare.min * 60 + timer.prepare.sec,
        isPaused: false
      };
      showTimerScreen();
      updateTimerDisplay();
      playSound(timer.prepare.startSound, timer.volume);
      vibrate([200, 100, 200]);
      enableWakeLock();
      timerInterval = setInterval(() => {
        if (!runningTimer.isPaused) {
          runningTimer.remainingTime--;
          if (runningTimer.remainingTime <= 5 && runningTimer.remainingTime > 0) {
            const phase = runningTimer.config[runningTimer.phase];
            playSound(phase.endSound, timer.volume);
            vibrate(100);
          }
          if (runningTimer.remainingTime <= 0) {
            vibrate([200, 100, 200, 100, 200]);
            nextPhase();
          }
          updateTimerDisplay();
        }
      }, 1000);
    }

    function nextPhase() {
      const timer = runningTimer.config;
      if (runningTimer.phase === 'prepare') {
        runningTimer.phase = 'work';
        runningTimer.remainingTime = timer.work.min * 60 + timer.work.sec;
        playSound(timer.work.startSound, timer.volume);
        vibrate([200, 100, 200]);
      } else if (runningTimer.phase === 'work') {
        runningTimer.phase = 'rest';
        runningTimer.remainingTime = timer.rest.min * 60 + timer.rest.sec;
        playSound(timer.rest.startSound, timer.volume);
        vibrate([200, 100, 200]);
      } else if (runningTimer.phase === 'rest') {
        if (runningTimer.currentRound < timer.rounds) {
          runningTimer.currentRound++;
          runningTimer.phase = 'work';
          runningTimer.remainingTime = timer.work.min * 60 + timer.work.sec;
          playSound(timer.work.startSound, timer.volume);
          vibrate([200, 100, 200]);
        } else {
          vibrate([300, 100, 300, 100, 300]);
          stopTimer();
          return;
        }
      }
      updateTimerDisplay();
    }

    function showTimerScreen() {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('timerScreen').classList.add('show');
      // 타이머 화면 표시 시 타이머 화면 설정 적용
      applyTimerScreenSettings();
    }

    function applyTimerScreenSettings() {
      const timerTimeEl = document.getElementById('timerTime');
      if (timerTimeEl) {
        timerTimeEl.style.fontSize = (timerScreenSettings.numberSize * 2) + 'px';
      }
      const infoTopEl = document.querySelector('.timer-info-top');
      const timerNameEl = document.querySelector('.timer-name');
      if (infoTopEl) {
        infoTopEl.style.fontSize = timerScreenSettings.textSize + 'px';
      }
      if (timerNameEl) {
        timerNameEl.style.fontSize = timerScreenSettings.textSize + 'px';
      }
    }

    function updateTimerDisplay() {
      if (!runningTimer) return;
      const minutes = Math.floor(runningTimer.remainingTime / 60);
      const seconds = runningTimer.remainingTime % 60;
      document.getElementById('timerMinutes').textContent = String(minutes).padStart(2, '0');
      document.getElementById('timerSeconds').textContent = String(seconds).padStart(2, '0');
      let phaseText = '';
      if (runningTimer.phase === 'prepare') phaseText = '준비';
      else if (runningTimer.phase === 'work') phaseText = '운동';
      else if (runningTimer.phase === 'rest') phaseText = '휴식';
      document.getElementById('timerPhase').textContent = phaseText;
      document.getElementById('timerRound').textContent = runningTimer.currentRound + '/' + runningTimer.config.rounds;
      document.getElementById('timerName').textContent = runningTimer.config.name;
      const phase = runningTimer.config[runningTimer.phase];
      document.getElementById('timerScreen').style.backgroundColor = phase.bg;
      document.getElementById('timerScreen').style.color = phase.color;
      
      // 배경색/글자색만 업데이트 (크기는 건드리지 않음)
      document.getElementById('currentTimeSmall').style.backgroundColor = globalSettings.bgColor;
      document.getElementById('currentTimeSmall').style.color = globalSettings.fontColor;
    }

    function handleTimerScreenClick(e) {
      if (e.target.id === 'stopGuide' || e.target.id === 'pauseOverlay' || longPressTimer) return;
      if (runningTimer.isPaused) {
        runningTimer.isPaused = false;
        document.getElementById('stopGuide').classList.remove('show');
        document.getElementById('timerScreen').classList.remove('paused');
        document.getElementById('pauseOverlay').classList.remove('show');
        vibrate(50);
        showToast('타이머 재개');
      } else {
        runningTimer.isPaused = true;
        document.getElementById('stopGuide').classList.add('show');
        document.getElementById('timerScreen').classList.add('paused');
        document.getElementById('pauseOverlay').classList.add('show');
        vibrate(50);
      }
    }

    function handleLongPressStart(e) {
      if (!runningTimer.isPaused) return;
      e.preventDefault();
      document.getElementById('progressCircle').classList.add('show', 'filling');
      longPressTimer = setTimeout(() => {
        vibrate(200);
        stopTimer();
      }, 2000);
    }

    function handleLongPressEnd(e) {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
        document.getElementById('progressCircle').classList.remove('show', 'filling');
      }
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      disableWakeLock();
      runningTimer = null;
      document.getElementById('timerScreen').classList.remove('show', 'paused');
      document.getElementById('mainScreen').style.display = 'flex';
      document.getElementById('stopGuide').classList.remove('show');
      document.getElementById('pauseOverlay').classList.remove('show');
      document.getElementById('progressCircle').classList.remove('show', 'filling');
    }

    function handleCustomSoundUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const soundName = file.name.split('.')[0];
          customSounds[soundName] = e.target.result;
          localStorage.setItem('customSounds', JSON.stringify(customSounds));
          addCustomSoundOption(soundName);
        };
        reader.readAsDataURL(file);
      });
      showToast('음원이 업로드되었습니다');
    }

    function addCustomSoundOption(soundName) {
      const selects = document.querySelectorAll('select[id$="Sound"]');
      selects.forEach(select => {
        const exists = Array.from(select.options).some(opt => opt.value === soundName);
        if (!exists) {
          const option = document.createElement('option');
          option.value = soundName;
          option.textContent = soundName;
          select.appendChild(option);
        }
      });
    }

    function playSound(soundType, volume) {
      if (!globalSettings.soundEnabled || soundType === 'none') return;
      const vol = volume / 100;
      if (customSounds[soundType]) {
        playCustomSound(customSounds[soundType], volume);
        return;
      }
      switch(soundType) {
        case 'beep':
          playTone(1000, 0.3, vol);
          break;
        case 'bell':
          playTone(800, 0.15, vol);
          setTimeout(() => playTone(1000, 0.15, vol), 150);
          setTimeout(() => playTone(800, 0.3, vol), 300);
          break;
        case 'default':
          playTone(800, 0.2, vol);
          setTimeout(() => playTone(600, 0.3, vol), 200);
          break;
      }
    }

    function playCustomSound(dataUrl, volume) {
      const audio = new Audio(dataUrl);
      audio.volume = volume / 100;
      audio.play().catch(err => console.log('소리 재생 실패:', err));
    }

    function playTone(frequency, duration, volume) {
      // 필요 시 AudioContext 초기화 (iOS 호환)
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (err) {
          console.log('AudioContext 초기화 실패:', err);
          return;
        }
      }

      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
      } catch (err) {
        console.log('소리 재생 실패:', err);
      }
    }

    function vibrate(pattern) {
      if (globalSettings.vibrationEnabled && 'vibrate' in navigator) {
        navigator.vibrate(pattern);
      }
    }

    async function enableWakeLock() {
      if (!globalSettings.keepScreenOn) return;
      try {
        if ('wakeLock' in navigator && navigator.wakeLock) {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('화면 꺼짐 방지 활성화');
        } else {
          console.log('이 브라우저는 WakeLock을 지원하지 않습니다');
        }
      } catch (err) {
        console.log('화면 꺼짐 방지 실패:', err);
      }
    }

    async function disableWakeLock() {
      if (wakeLock) {
        try {
          await wakeLock.release();
          wakeLock = null;
          console.log('화면 꺼짐 방지 해제');
        } catch (err) {
          console.log('WakeLock 해제 실패:', err);
        }
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showTimerScreenSettings() {
      document.getElementById('timerNumberSize').value = timerScreenSettings.numberSize;
      document.getElementById('timerNumberSizeValue').textContent = timerScreenSettings.numberSize + '%';
      document.getElementById('timerTextSize').value = timerScreenSettings.textSize;
      document.getElementById('timerTextSizeValue').textContent = timerScreenSettings.textSize + '%';
      document.getElementById('timerScreenSettingsModal').classList.add('show');
      
      document.getElementById('timerNumberSize').oninput = function() {
        document.getElementById('timerNumberSizeValue').textContent = this.value + '%';
        const timerTimeEl = document.getElementById('timerTime');
        if (timerTimeEl) {
          timerTimeEl.style.fontSize = (this.value * 2) + 'px';
        }
      };
      
      document.getElementById('timerTextSize').oninput = function() {
        document.getElementById('timerTextSizeValue').textContent = this.value + '%';
        const infoTopEl = document.querySelector('.timer-info-top');
        const timerNameEl = document.querySelector('.timer-name');
        if (infoTopEl) {
          infoTopEl.style.fontSize = this.value + 'px';
        }
        if (timerNameEl) {
          timerNameEl.style.fontSize = this.value + 'px';
        }
      };
    }

    function closeTimerScreenSettings() {
      document.getElementById('timerScreenSettingsModal').classList.remove('show');
    }

    function saveTimerScreenSettings() {
      timerScreenSettings.numberSize = parseInt(document.getElementById('timerNumberSize').value);
      timerScreenSettings.textSize = parseInt(document.getElementById('timerTextSize').value);
      localStorage.setItem('timerScreenSettings', JSON.stringify(timerScreenSettings));
      applyTimerScreenSettings();  // 즉시 적용
      closeTimerScreenSettings();
      showToast('타이머 화면 설정이 저장되었습니다');
    }

    function loadTimerScreenSettings() {
      const saved = localStorage.getItem('timerScreenSettings');
      if (saved) {
        const parsed = JSON.parse(saved);
        timerScreenSettings = Object.assign(timerScreenSettings, parsed);
      }
    }

    function saveTimers() {
      localStorage.setItem('timers', JSON.stringify(timers));
    }

    function loadTimers() {
      const saved = localStorage.getItem('timers');
      if (saved) {
        timers = JSON.parse(saved);
      } else {
        timers = [{
          id: 'timer_default',
          name: '기본 타이머',
          prepare: { min: 0, sec: 10, bg: '#FFA500', color: '#FFFFFF', startSound: 'default', endSound: 'beep' },
          work: { min: 0, sec: 30, bg: '#FF0000', color: '#FFFFFF', startSound: 'default', endSound: 'beep' },
          rest: { min: 0, sec: 10, bg: '#00FF00', color: '#000000', startSound: 'default', endSound: 'beep' },
          rounds: 3,
          volume: 50
        }];
      }
    }

    function loadSettings() {
      const saved = localStorage.getItem('globalSettings');
      if (saved) {
        const parsed = JSON.parse(saved);
        globalSettings = Object.assign(globalSettings, parsed);
      }
      const savedSounds = localStorage.getItem('customSounds');
      if (savedSounds) {
        customSounds = JSON.parse(savedSounds);
        Object.keys(customSounds).forEach(soundName => {
          addCustomSoundOption(soundName);
        });
      }
    }
  </script>
</body>
</html>